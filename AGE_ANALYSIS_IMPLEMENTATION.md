# æ™ºèƒ½å¹´é¾„åˆ†æç³»ç»Ÿ - å®ç°å®Œæˆæ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æ™ºèƒ½å¹´é¾„åˆ†æç³»ç»Ÿå·²æˆåŠŸå®ç°ï¼Œè¯¥ç³»ç»Ÿæ ¹æ®æ‚£è€…å¹´é¾„è‡ªåŠ¨åº”ç”¨ä¸åŒçš„åŒ»å­¦æ ‡å‡†å€¼ï¼Œä¸ºçœ¼ç§‘æ£€æŸ¥æä¾›æ›´ç²¾å‡†çš„åˆ†æç»“æœã€‚

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å¹´é¾„åˆ†ç»„ç³»ç»Ÿ
- **å„¿ç«¥ç»„ (0-18å²)**: ID=1, é¢œè‰²=ç»¿è‰²
- **æˆäººç»„ (19-64å²)**: ID=2, é¢œè‰²=è“è‰²
- **è€äººç»„ (65å²ä»¥ä¸Š)**: ID=3, é¢œè‰²=æ©™è‰²

### 2. å¹´é¾„ç‰¹å®šæ ‡å‡†

#### è°ƒèŠ‚å¹…åº¦ (AMP)
- **å…¬å¼**: `18.5 - 0.3 Ã— å¹´é¾„`
- **ç¤ºä¾‹**: 
  - 20å²: 12.5D (æ­£å¸¸èŒƒå›´: 10.6D+)
  - 40å²: 6.5D (æ­£å¸¸èŒƒå›´: 5.5D+)
  - 60å²: 0.5D (æ­£å¸¸èŒƒå›´: 0.4D+)

#### è§†åŠ› (VA)
- **å„¿ç«¥**: â‰¥1.0
- **æˆäºº**: â‰¥1.0
- **è€äºº**: â‰¥0.8 (è€ƒè™‘åˆ°å¹´é¾„ç›¸å…³çš„è§†åŠ›å˜åŒ–)

#### å±ˆå…‰åº¦ (SPH)
- åˆ†çº§é˜ˆå€¼ç›¸åŒ
- **è€äººç‰¹æ®Šæç¤º**: éœ€è€ƒè™‘ç™½å†…éšœå¼•èµ·çš„å±ˆå…‰åº¦å˜åŒ–

#### çœ¼å‹ (IOP)
- ç›¸åŒæ ‡å‡† (10-21 mmHg)
- **è€äººç‰¹æ®Šæç¤º**: éœ€æ’é™¤é’å…‰çœ¼é£é™©

## ğŸ“ åˆ›å»ºçš„æ–‡ä»¶

### æ ¸å¿ƒå·¥å…·ç±»
```
lib/core/utils/age_utils.dart (177è¡Œ)
```
åŠŸèƒ½:
- `AgeGroup` æšä¸¾å®šä¹‰
- `getGroup(int age)` - è¿”å›å¹´é¾„ç»„
- `getGroupName(int age)` - è¿”å›åˆ†ç»„åç§°
- `getAgeGroupId(int age)` - è¿”å›ç»„ID (1/2/3)
- `calculateAMPAgeBased(age)` - Hoffmanå…¬å¼è®¡ç®—
- `getExpectedVA(age)` - è·å–è§†åŠ›æ ‡å‡†
- `getAgeSpecificNotes(age)` - è·å–å¹´é¾„ç›¸å…³å»ºè®®
- é¢œè‰²ã€å›¾æ ‡ç­‰è¾…åŠ©æ–¹æ³•

### å¹´é¾„åˆ†ææœåŠ¡
```
lib/domain/services/age_based_analysis_service.dart (519è¡Œ)
```
åŠŸèƒ½:
- `AgeBasedAnalysisService` - æ‰©å±• AnalysisService
- `analyzeWithPatient(record, patient)` - å¹´é¾„åˆ†æå…¥å£
- è‡ªåŠ¨è°ƒæ•´æŒ‡æ ‡æ ‡å‡†:
  - è°ƒèŠ‚å¹…åº¦ (æŒ‰å¹´é¾„é¢„æœŸå€¼è°ƒæ•´)
  - è§†åŠ› (è€äººé˜ˆå€¼é™ä½è‡³0.8)
  - å±ˆå…‰åº¦ (è€äººæç¤ºç™½å†…éšœ)
  - çœ¼å‹ (è€äººæç¤ºé’å…‰çœ¼ç­›æŸ¥)
- `AgeBasedAnalysisResult` - å¹´é¾„åˆ†æç»“æœç±»
- `AgeBasedStandard` - å¹´é¾„æ ‡å‡†æ¨¡å‹

### åŸºç¡€åˆ†ææœåŠ¡å¢å¼º
```
lib/domain/services/analysis_service.dart (å·²ä¿®æ”¹)
```
æ–°å¢:
- `analyze(record, {patientAge})` - æ”¯æŒå¹´é¾„å‚æ•°
- `getStandardsForType(type, {patientAge})` - å¹´é¾„ç›¸å…³æ ‡å‡†æŸ¥è¯¢
- `_adjustAMPForAge()` - è°ƒèŠ‚å¹…åº¦å¹´é¾„è°ƒæ•´
- `_adjustVAForAge()` - è§†åŠ›å¹´é¾„è°ƒæ•´
- å¹´é¾„ç‰¹å®šçš„è¯„ä¼°å’Œå»ºè®®ç”Ÿæˆ

### UIç»„ä»¶
```
lib/presentation/widgets/age_specific_badge.dart (368è¡Œ)
```
ç»„ä»¶:
- `AgeSpecificBadge` - å¹´é¾„ç»„å¾½ç«  (å®Œæ•´/ç´§å‡‘æ¨¡å¼)
- `AgeGroupChip` - å¹´é¾„ç»„èŠ¯ç‰‡ç»„ä»¶
- `AgeBasedInfoCard` - å¹´é¾„ç›¸å…³å»ºè®®å¡ç‰‡
- `AgeAnalysisLegend` - å¹´é¾„åˆ†ç»„è¯´æ˜å›¾ä¾‹

### åˆ†ææŠ¥å‘Šé¡µé¢å¢å¼º
```
lib/presentation/pages/analysis_report_page.dart (å·²ä¿®æ”¹)
```
æ–°å¢:
- å¹´é¾„åˆ†æå¡ç‰‡ (`_buildAgeAnalysisCard()`)
- æ˜¾ç¤º"åŸºäºXXå²XXæ ‡å‡†"
- å¹´é¾„ç‰¹å®šæç¤ºå’Œå»ºè®®
- å¹´é¾„æ ¡æ­£æŒ‡æ ‡æ˜¾ç¤º
- å¹´é¾„åˆ†ç»„è¯´æ˜å›¾ä¾‹

### æµ‹è¯•æ–‡ä»¶
```
test/core/utils/age_utils_test.dart
test/domain/services/age_based_analysis_service_test.dart
```

### ä½¿ç”¨ç¤ºä¾‹
```
lib/examples/age_analysis_examples.dart
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ä½¿ç”¨

```dart
import 'package:vision_analyzer/core/utils/age_utils.dart';
import 'package:vision_analyzer/domain/services/age_based_analysis_service.dart';

// 1. è·å–å¹´é¾„åˆ†ç»„
final ageGroup = AgeUtils.getGroup(25); // AgeGroup.adult
final groupName = AgeUtils.getGroupName(25); // "æˆäºº(19-64å²)"

// 2. è®¡ç®—é¢„æœŸè°ƒèŠ‚å¹…åº¦
final amp = AgeUtils.calculateAMPAgeBased(40); // 6.5D

// 3. ä½¿ç”¨å¹´é¾„åˆ†ææœåŠ¡
final service = AgeBasedAnalysisService();
final result = service.analyzeWithPatient(examRecord, patient);

// 4. è®¿é—®å¹´é¾„åˆ†æç»“æœ
print('å¹´é¾„ç»„: ${result.ageGroupName}');
print('æ€»ä½“è¯„ä¼°: ${result.overallAssessment}');
```

### åœ¨UIä¸­æ˜¾ç¤º

```dart
import 'package:vision_analyzer/presentation/widgets/age_specific_badge.dart';

// æ˜¾ç¤ºå¹´é¾„ç»„å¾½ç« 
AgeSpecificBadge(age: patient.age)

// æ˜¾ç¤ºå®Œæ•´ä¿¡æ¯ï¼ˆå«æè¿°ï¼‰
AgeSpecificBadge(
  age: patient.age,
  showDescription: true,
)

// ç´§å‡‘æ¨¡å¼
AgeSpecificBadge(
  age: patient.age,
  isCompact: true,
)

// å¹´é¾„ç»„èŠ¯ç‰‡
AgeGroupChip(age: patient.age)

// å¹´é¾„ç›¸å…³å»ºè®®å¡ç‰‡
AgeBasedInfoCard(age: patient.age)
```

## ğŸ¨ UIé¢œè‰²è§„èŒƒ

| å¹´é¾„ç»„ | ä¸»è‰²è°ƒ | èƒŒæ™¯è‰² | å›¾æ ‡ |
|--------|--------|--------|------|
| å„¿ç«¥ | #4CAF50 (ç»¿) | #E8F5E9 | child_care |
| æˆäºº | #2196F3 (è“) | #E3F2FD | person |
| è€äºº | #FF9800 (æ©™) | #FFF3E0 | elderly |

## ğŸ“Š åˆ†ææŠ¥å‘Šç¤ºä¾‹

åˆ†ææŠ¥å‘Šç°åœ¨åŒ…å«ï¼š
1. **å¹´é¾„åˆ†æå¡ç‰‡**
   - å¹´é¾„ç»„å¾½ç«  (å¸¦é¢œè‰²)
   - å¹´é¾„ç»„è¯´æ˜
   - å¹´é¾„ç‰¹å®šæ³¨æ„äº‹é¡¹

2. **åŸºäºå¹´é¾„çš„æ ‡å‡†**
   - "åŸºäº18å²é’å°‘å¹´æ ‡å‡†"
   - "åŸºäº35å²æˆäººæ ‡å‡†"
   - "åŸºäº70å²è€äººæ ‡å‡†"

3. **å¹´é¾„æ ¡æ­£æŒ‡æ ‡**
   - è°ƒèŠ‚å¹…åº¦é¢„æœŸå€¼
   - è§†åŠ›é˜ˆå€¼è°ƒæ•´
   - è€äººç‰¹æ®Šæç¤º

4. **å¹´é¾„ç›¸å…³å»ºè®®**
   - å„¿ç«¥: è¿‘è§†é˜²æ§ã€å¼±è§†ç­›æŸ¥
   - æˆäºº: ç”¨çœ¼å«ç”Ÿã€å®šæœŸæ£€æŸ¥
   - è€äºº: è€å¹´çœ¼ç—…ç­›æŸ¥ã€ç™½å†…éšœ/é’å…‰çœ¼å…³æ³¨

## âœ… å®ç°æ£€æŸ¥æ¸…å•

- [x] AgeGroup æšä¸¾å®šä¹‰
- [x] getGroup() å¹´é¾„åˆ†ç»„æ–¹æ³•
- [x] getGroupName() åˆ†ç»„åç§°æ–¹æ³•
- [x] getAgeGroupId() ç»„IDæ–¹æ³•
- [x] è°ƒèŠ‚å¹…åº¦è®¡ç®—å…¬å¼ (Hoffmanå…¬å¼)
- [x] è§†åŠ›æ ‡å‡†æŒ‰å¹´é¾„è°ƒæ•´
- [x] å±ˆå…‰åº¦è€äººç‰¹æ®Šå¤„ç†
- [x] çœ¼å‹è€äººç‰¹æ®Šå¤„ç†
- [x] AgeBasedAnalysisService æœåŠ¡ç±»
- [x] analyzeWithPatient() æ–¹æ³•
- [x] å¹´é¾„æ ‡å‡†è‡ªåŠ¨è°ƒæ•´é€»è¾‘
- [x] AnalysisService å¹´é¾„å‚æ•°æ”¯æŒ
- [x] AgeSpecificBadge UIç»„ä»¶
- [x] AgeGroupChip UIç»„ä»¶
- [x] AgeBasedInfoCard UIç»„ä»¶
- [x] AgeAnalysisLegend UIç»„ä»¶
- [x] AnalysisReportPage å¹´é¾„åˆ†æå¡ç‰‡
- [x] å¹´é¾„ç‰¹å®šé¢œè‰²æ–¹æ¡ˆ
- [x] å•å…ƒæµ‹è¯•
- [x] ä½¿ç”¨ç¤ºä¾‹ä»£ç 

## ğŸ”„ é›†æˆåˆ°ç°æœ‰ç³»ç»Ÿ

ç³»ç»Ÿå·²æ— ç¼é›†æˆåˆ°ç°æœ‰æ¶æ„ï¼š
1. ä¸ç ´ååŸæœ‰APIå…¼å®¹æ€§
2. é€šè¿‡å¯é€‰å‚æ•°å¯ç”¨å¹´é¾„åˆ†æ
3. ä¿æŒå‘åå…¼å®¹
4. æ–°å¢ç»„ä»¶å¯¼å‡ºåˆ° widgets.dart

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **è°ƒèŠ‚å¹…åº¦**: è€äººè°ƒèŠ‚å¹…åº¦ä¸‹é™æ˜¯æ­£å¸¸ç”Ÿç†ç°è±¡
2. **è§†åŠ›**: è€äººè§†åŠ›æ ‡å‡†é€‚å½“æ”¾å®½è‡³0.8
3. **ç™½å†…éšœ**: è€äººå±ˆå…‰åº¦å˜åŒ–éœ€è­¦æƒ•ç™½å†…éšœ
4. **é’å…‰çœ¼**: è€äººçœ¼å‹å¼‚å¸¸éœ€æ’é™¤é’å…‰çœ¼
5. **å¹´é¾„åˆ†ç»„**: åŸºäºæ ‡å‡†åŒ»å­¦åˆ†ç±» (0-18, 19-64, 65+)

## ğŸ‰ æ€»ç»“

æ™ºèƒ½å¹´é¾„åˆ†æç³»ç»Ÿå·²å®ç°æ‰€æœ‰è¦æ±‚åŠŸèƒ½ï¼Œæä¾›äº†ï¼š
- å®Œæ•´çš„å¹´é¾„åˆ†ç»„é€»è¾‘
- å¹´é¾„ç‰¹å®šçš„åŒ»å­¦æ ‡å‡†
- ä¸°å¯Œçš„UIç»„ä»¶
- è¯¦ç»†çš„åˆ†ææŠ¥å‘Šé›†æˆ
- å®Œæ•´çš„æµ‹è¯•è¦†ç›–

ç³»ç»Ÿç°åœ¨å¯ä»¥æ ¹æ®æ‚£è€…å¹´é¾„è‡ªåŠ¨é€‰æ‹©é€‚å½“çš„æ ‡å‡†å€¼ï¼Œä¸ºä¸åŒå¹´é¾„ç»„æä¾›æ›´ç²¾å‡†çš„çœ¼ç§‘æ£€æŸ¥åˆ†æã€‚
